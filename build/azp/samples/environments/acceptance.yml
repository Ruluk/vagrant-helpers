parameters:
  options: []
    # - environment: environment-name
    #   machines: [ 'machine-name' ]
    #   providers: [ 'provider-name' ]

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each option in parameters.options }}:
        - ${{ each machine in option.machines }}:
          - ${{ each provider in option.providers }}:
            - job: test_${{ option.environment }}_${{ machine }}_${{ provider }}
              displayName: Test ${{ option.environment }} on ${{ machine }} with ${{ provider }}

              pool:
                name: Default
                demands:
                  - AZP_AGENT_VAGRANT -equals ${{ provider }}

              workspace:
                clean: all

              steps:
                - checkout: self
                  submodules: recursive

                - script: |
                    vagrant version
                    vagrant plugin list
                  displayName: Init

                - script: |
                    cd samples/environments/${{ option.environment }}
                    vagrant up ${{ machine }} --provider ${{ provider }}
                  displayName: Test

                - script: |
                    cd samples/environments/${{ option.environment }}
                    vagrant destroy --force ${{ machine }}
                  displayName: Clean
                  condition: always()
