parameters:
  options: []

stages:
  - stage: commit
    displayName: Commit

    jobs:
      - ${{ each option in parameters.options }}:
        - job: build_${{ option.environment }}
          displayName: Build ${{ option.environment }}

          pool:
            vmImage: ubuntu-16.04

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
              displayName: Init

            - script: |
                docker-compose build vagrant
              displayName: Restore

            - script: |
                docker-compose run -e VAGRANT_CWD=./samples/environments/${{ option.environment }} vagrant validate --ignore-provider
              displayName: Test

            - script: |
                docker-compose down
              displayName: Clean
              condition: always()

      - ${{ each option in parameters.options }}:
        - job: analyze_${{ option.environment }}
          displayName: Analyze ${{ option.environment }}

          pool:
            vmImage: ubuntu-16.04

          workspace:
            clean: all

          steps:
            - checkout: self
              submodules: recursive

            - script: |
                docker version
                docker-compose version
              displayName: Init

            - script: |
                docker-compose build rubocop
              displayName: Restore

            - script: |
                docker-compose run rubocop ./samples/environments/${{ option.environment }}
              displayName: Test

            - script: |
                docker-compose down
              displayName: Clean
              condition: always()
