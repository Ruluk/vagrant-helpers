parameters:
  samples: [ 'machines', 'providers', 'provisioners' ]
  machines: [ 'windows', 'linux' ]
  providers: [ 'virtualbox', 'hyperv' ]

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each sample in parameters.samples }}:
        - ${{ each machine in parameters.machines }}:
          - ${{ each provider in parameters.providers }}:
            - job: test_${{ sample }}_${{ machine }}_${{ provider }}
              displayName: Test ${{ sample }} on ${{ machine }} with ${{ provider }}

              pool:
                name: Default
                demands:
                  - AZP_AGENT_VAGRANT -equals ${{ provider }}

              workspace:
                clean: all

              steps:
                - checkout: self
                  submodules: recursive

                - script: |
                    vagrant version
                    vagrant plugin list
                  displayName: Init

                - script: |
                    cd ./samples/${{ sample }}
                    pwd

                    vagrant up ${{ machine }} --provider ${{ provider }}
                  displayName: Test - Up ${{ sample }} on ${{ machine }} with ${{ provider }}

                - script: |
                    cd ./samples/${{ sample }}
                    pwd

                    vagrant destroy -f ${{ machine }}
                  displayName: Clean - Destroy ${{ sample }} on ${{ machine }}
                  condition: always()
