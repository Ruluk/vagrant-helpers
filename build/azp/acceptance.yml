parameters:
  samples: [ 'machines', 'providers', 'provisioners' ]
  providers: [ 'virtualbox', 'hyperv' ]

stages:
  - stage: acceptance
    displayName: Acceptance

    jobs:
      - ${{ each provider in parameters.providers }}:
        - job: test_${{ provider }}
          displayName: Test ${{ provider }}

          pool:
            name: Default
            demands:
              - AZP_AGENT_VAGRANT -equals ${{ provider }}

          workspace:
            clean: all

          steps:
            - script: |
                vagrant version
                vagrant plugin list
              displayName: Init

            - ${{ each sample in parameters.samples }}:
              - script: |
                  cd ./samples/${{ sample }}
                  vagrant up linux
                displayName: Test ${{ sample }}

              - script: |
                  cd ./samples/${{ sample }}
                  vagrant destroy -f linux
                displayName: Clean ${{ sample }}
                condition: always()
